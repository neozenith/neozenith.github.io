(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{198:function(t,e,a){"use strict";a.r(e);var s=a(0),n=Object(s.a)({},function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/books.jpg"),alt:"Reference books on my desk"}})]),t._v(" "),a("h1",{attrs:{id:"page-title"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#page-title","aria-hidden":"true"}},[t._v("#")]),t._v(" "+t._s(t.$page.title))]),t._v(" "),a("p",[a("span",{staticStyle:{color:"#999"}},[t._v(t._s(t.$page.readingTime.text)+"...")])]),t._v(" "),a("p",[t._v("This article is mostly for me to process my thoughts but also to pave a path for anyone that wants to follow a similar journey on some more advanced python testing topics.")]),t._v(" "),a("p",[t._v("I recently had the opportunity to "),a("em",[t._v("garbage collect")]),t._v("  a bunch of common libraries at my company into a new python library and git repository. Marking all the critical path libraries and copying them over, and sweeping away the unused cruft.")]),t._v(" "),a("p",[t._v("This meant instituting some open source practices of "),a("a",{attrs:{href:"#basci-code-quality"}},[t._v("code quality")]),t._v(" around our core library like testing.")]),t._v(" "),a("p",[t._v("One of the main hurdles I hit was that our API wrapper code was flaky. It would randomly fail and it meant no-one trusted the tests.")]),t._v(" "),a("p",[t._v("The problem was that the existing tests were designed to test the underlying database/API instead of the wrapper code itself. Thanks to "),a("a",{attrs:{href:"https://twitter.com/brianokken/status/1140499269905870848",target:"_blank",rel:"noopener noreferrer"}},[t._v("some help on twitter"),a("OutboundLink")],1),t._v(" I landed on "),a("a",{attrs:{href:"https://pypi.org/project/pytest-vcr/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-vcr")]),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("I guess I'm adhereing to "),a("a",{attrs:{href:"https://twitter.com/kvlly/status/1139912868307066880?s=21",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twitter Driven Development"),a("OutboundLink")],1)]),t._v(" "),a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/tdd.jpg"),alt:"In response to 'what is your worst programming advice: Twitter Driven Development",width:"50%"}})]),t._v(" "),a("p",[t._v("It creates "),a("code",[t._v(".yml")]),t._v(" files to record the http requests per test on the first run, then replays them on subsequent runs of the test. Any request that doesn't match what was previously recorded is a failure as it is malformed from the expectation. It's easy to re-record a new expectation of requests per test too! Since it replays the request, it also allows the existing test assertions about the validity of the reponse to suffice too.")]),t._v(" "),a("p",[t._v("That's the "),a("strong",[t._v("tl;dr")]),t._v(" but feel free to read through the rest of the narrative or just check out the "),a("a",{attrs:{href:"#references"}},[t._v("list of references")]),t._v(" at the end.")]),t._v(" "),a("h1",{attrs:{id:"contents"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#contents","aria-hidden":"true"}},[t._v("#")]),t._v(" Contents")]),t._v(" "),a("p",[t._v("The article is laid out in a few main sections:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"#overview"}},[t._v("Overview")]),t._v(": If you only have a few minutes")]),t._v(" "),a("li",[a("a",{attrs:{href:"#background-about-me"}},[t._v("Background About Me")]),t._v(": Feel free to skip, but it gives context about my motivation.")]),t._v(" "),a("li",[a("a",{attrs:{href:"#training-montage"}},[t._v("Training Montage")]),t._v(": Narrative around some very helpful learning resources")]),t._v(" "),a("li",[a("a",{attrs:{href:"#basic-code-quality"}},[t._v("Basic Code Quality")]),t._v(": If you are new to software engineering and testing, please read.")]),t._v(" "),a("li",[a("a",{attrs:{href:"#advanced-testing"}},[t._v("Advanced Testing")]),t._v(": Leveraging Mocks, Stubs, Spies, Monkey Patches and Fixtures.")]),t._v(" "),a("li",[a("a",{attrs:{href:"#conclusion"}},[t._v("Conclusion")]),t._v(": My key take aways if you only have 5 minutes.")]),t._v(" "),a("li",[a("a",{attrs:{href:"#references"}},[t._v("References")]),t._v(": Links to all resources mentioned.")])]),t._v(" "),a("h1",{attrs:{id:"background-about-me"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#background-about-me","aria-hidden":"true"}},[t._v("#")]),t._v(" Background About Me")]),t._v(" "),a("p",[t._v("A little about me though, I'm a Software Engineer and recently qualified Data Scientist working for Komatsu mining.")]),t._v(" "),a("blockquote",[a("p",[t._v("DISCLAIMER: All views expressed here are my own and do not reflect that of my current employer or any former companies or organisations I have been affiliated with.")])]),t._v(" "),a("p",[a("strong",[t._v("2010-2016")])]),t._v(" "),a("p",[t._v("With that out of the way, I was a data engineer for a startup (2010-2016) using Python for our ETL heavily. So much so I gave a talk about "),a("router-link",{attrs:{to:"/posts/2016-11-12-unit-test-data.html"}},[t._v("Unit Testing Data")]),t._v(".")],1),t._v(" "),a("p",[t._v("I also tried to contribute to the AWS python SDK and that is when I learnt the value of automating open source projects. My code had to automatically pass a litany of testing and the test coverage wasn't allowed to regress lower then where it started.")]),t._v(" "),a("p",[a("strong",[t._v("If and only if")]),t._v(" I passed all these requirements would a real human start checking my PR! This is a much better use human effort.")]),t._v(" "),a("p",[t._v("Even if it wasn't AWS, but a volunteer open source project, this sort of automation is like having robot colleagues to help your project stay on track! Volunteer time is often time away from family. So the 2-3 hours you do have on a project each week are precious so you want them to be of the most value.")]),t._v(" "),a("p",[t._v("This is something that stuck with me and I will touch on further below in "),a("a",{attrs:{href:"#basic-code-quality"}},[t._v("Basic Code Quality")]),t._v(". Why don't corporations take on these practices? I often ask:")]),t._v(" "),a("blockquote",[a("p",[t._v("Would you volunteer on this code base?")])]),t._v(" "),a("p",[a("strong",[t._v("2016-2018")])]),t._v(" "),a("p",[t._v("Between 2016-2018 I worked as a Software engineer at "),a("a",{attrs:{href:"https://www.cloudsense.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CloudSense"),a("OutboundLink")],1),t._v(" which has by far the most impressive code base I have ever worked on.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("private "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" repo host"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Login into private container registry and npm registry")]),t._v("\ndocker login\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" login\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n")])])]),a("p",[t._v("In under 15 minutes of my first day, they had pulled down the source code, built the API server container and MongoDB, Redis and PostgreSQL fixture containers. They're test suite async-awaited the services to start up as fixtures then ran and cleaned up.")]),t._v(" "),a("p",[t._v("All with code coverage above 80%. Since they integrate with Salesforce, Salesforce enforces 75% code coverage for all Apex code that gets deployed, so CloudSense set the bar higher to allow a buffer.")]),t._v(" "),a("p",[a("strong",[t._v("2019")])]),t._v(" "),a("p",[t._v("Fast forward to 2019 and I've been with Komatsu for almost a year and have studied a Graduate Diploma of Data Science. The importance of designing statistical experiment,is by far the most important lesson I learned with the lens of a Software Engineer. When ever I'm modifying code or debugging I'm 10x faster by being deliberate about what I'm about to test. A failure or a new error message is information to learn from. So automating tests significantly reduces to cost and cycle time to getting answers.")]),t._v(" "),a("p",[t._v("That said, 2016-2018 I was away from the Python ecosystem and I needed to catch up for this new role at Komatsu. So below I'm going to list the resources that were critical in my "),a("a",{attrs:{href:"#training-montage"}},[t._v("Training Montage")])]),t._v(" "),a("h1",{attrs:{id:"training-montage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#training-montage","aria-hidden":"true"}},[t._v("#")]),t._v(" Training Montage")]),t._v(" "),a("p",[t._v("Having to catch up on 2 years of Python is no mean feat. Also Software Engineering is like music theory. You don't have to relearn everything, for each new instrument. Python, Node.JS, C++, etc... these are the instruments.")]),t._v(" "),a("p",[t._v("The three main areas that were helpful were Podcasts, Tutorials and books.")]),t._v(" "),a("h2",{attrs:{id:"podcasts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#podcasts","aria-hidden":"true"}},[t._v("#")]),t._v(" Podcasts")]),t._v(" "),a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/pycon2019-podcasts.jpg"),alt:"PyCon2019: Me with the podcast hosts Brian Okken and Michael Kennedy",height:"200"}})]),t._v(" "),a("p",[t._v("So the first step to catching up on 2 years is downloading the 2 year back catalog of the folowing podcasts:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://talkpython.fm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Talk Python to Me"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://testandcode.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Test and Code"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pythonbytes.fm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python Bytes"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("In around 8 weeks of commuting to work, mowing the lawn and ironing shirts I caught up. Also listening at 1.5x speed is your friend. I was lucky enough to attend PyCon2019 and meet the hosts Brian Okken and Michael Kennedy and thank them.")]),t._v(" "),a("h2",{attrs:{id:"real-python-articles"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#real-python-articles","aria-hidden":"true"}},[t._v("#")]),t._v(" Real Python articles")]),t._v(" "),a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/pycon2019-realpython.jpg"),alt:"PyCon2019: Me with the Real Python team, Dan Bader and Geir Arne Hjelle",height:"200"}})]),t._v(" "),a("p",[t._v("The team at "),a("a",{attrs:{href:"https://realpython.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python"),a("OutboundLink")],1),t._v(" are absolutely killing it with Python educational materials. I love how they have standardised on an article format and are pushing new articles every week.")]),t._v(" "),a("p",[t._v("I would get into work an hour before everyone else, sit down with a coffee and read through an article everyday until I felt the gaps had been filled.")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://realpython.com/pypi-publish-python-package/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Packaging a Python Library"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/pipenv-guide/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: A guide to Pipenv"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/python-testing/#testing-in-multiple-environments",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Automated Testing - Multiple Environments"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/python-mock-library/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Python Mock Library"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"python-testing-with-pytest-book"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#python-testing-with-pytest-book","aria-hidden":"true"}},[t._v("#")]),t._v(" Python Testing with PyTest book")]),t._v(" "),a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/bopytest.jpg"),alt:"Book Cover: Python Testing with pytest - Brian Okken",height:"200"}})]),t._v(" "),a("p",[t._v("Whilst I was at PyCon I thought I'd grab a physical copy of the "),a("a",{attrs:{href:"https://pragprog.com/book/bopytest/python-testing-with-pytest",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python Testing with pytest"),a("OutboundLink")],1),t._v(" book for the office thinking I wouldn't need it since I'd already gone pretty deep into python and pytest already.")]),t._v(" "),a("blockquote",[a("p",[t._v("NARRATOR: He was wrong.")])]),t._v(" "),a("p",[t._v("So I decided if I was going to inflict this upon my colleagues I should read it myself. The first 3 chapters are a minimum for everyday use. The last 4 chapters were the crucial knowledge of fixtures and plugins that really blew my mind on what pytest could do and how extensible the platform is.")]),t._v(" "),a("p",[t._v("Ok, montage complete! Now to test some things.")]),t._v(" "),a("h1",{attrs:{id:"basic-code-quality"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#basic-code-quality","aria-hidden":"true"}},[t._v("#")]),t._v(" Basic Code Quality")]),t._v(" "),a("p",[t._v("Have you ever worked on a code base that looks like a patchwork of conflicting code styles and nothing is consistent?")]),t._v(" "),a("p",[t._v("Ever worked on a code base that is just beautiful and consistent?")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Cognitive_load",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cognitive Load"),a("OutboundLink")],1),t._v(" is how fat the pipe is for our mental bandwidth to download new information. Just like reading XML versus JSON as a human, the extra symbols take more space over the wire, they take more cognitive load to process.")]),t._v(" "),a("p",[t._v("Inconsistent styles are breaks in our understanding of the grammmar of information presented which adds unnecessary cognitive load and less attention span to detect the actual gnarly bugs.")]),t._v(" "),a("p",[t._v("It's funny how to motivate people about code quality though.")]),t._v(" "),a("p",[t._v("Person to person nag them and they'll ignore you.")]),t._v(" "),a("p",[t._v("However a bot that flat out blocks their PR until they perform some basic code hygiene, whilst a boss is breathing down their neck to hit timelines.... and then it gets done.")]),t._v(" "),a("p",[t._v("I like to call this "),a("em",[t._v("getting someone stuck between a boss and a not so hard place")]),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"a-basic-test"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#a-basic-test","aria-hidden":"true"}},[t._v("#")]),t._v(" A basic test")]),t._v(" "),a("p",[t._v("Just so we are clear, here is a basic example of a pytest test:")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pytest\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Config\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datawarehouse "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" DataWarehouse\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestDataWarehouse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fixture\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dwh_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parametrize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"names"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ids"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NamesOnly"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"All"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test_get_all_metrics")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Given")]),t._v("\n        dwh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" DataWarehouse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("envir"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# When")]),t._v("\n        results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dwh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_all_metrics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name_only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Then")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" results "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("isinstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),a("p",[t._v("Here the test is "),a("code",[t._v("test_get_all_metrics")]),t._v(".")]),t._v(" "),a("p",[t._v("It pulls in the "),a("code",[t._v("dwh_config")]),t._v(" "),a("a",{attrs:{href:"#fixtures"}},[t._v("fixture")]),t._v(" which I'll cover later.")]),t._v(" "),a("p",[t._v("It also uses "),a("a",{attrs:{href:"https://docs.pytest.org/en/latest/parametrize.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest")]),t._v("'s parametrizing decorator"),a("OutboundLink")],1),t._v(" to run the same test multiple times with different data configurations.")]),t._v(" "),a("p",[t._v("The key practice that makes testing really really easy is the "),a("em",[t._v("Given/When/Then")]),t._v(" framework which makes the process of writing tests calmingly methodic and digestable.")]),t._v(" "),a("h3",{attrs:{id:"given"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#given","aria-hidden":"true"}},[t._v("#")]),t._v(" Given")]),t._v(" "),a("p",[t._v("Everything I need to setup a test. This can consist of test data but also of setting up a database connection using "),a("a",{attrs:{href:"#fixtures"}},[t._v("fixtures")]),t._v(" which I promise I'll cover later. The distinction I like is that fixtures return "),a("code",[t._v("ERROR")]),t._v("s where as tests throw "),a("code",[t._v("FAIL")]),t._v("s.")]),t._v(" "),a("h3",{attrs:{id:"when"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#when","aria-hidden":"true"}},[t._v("#")]),t._v(" When")]),t._v(" "),a("p",[t._v("The part of the code under test. I try to make this section one line of code so it is really clear what is being tested and how a user would write the same line of code. It forces me to think about the Developer Experience (DX) of the API design.")]),t._v(" "),a("h3",{attrs:{id:"then"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#then","aria-hidden":"true"}},[t._v("#")]),t._v(" Then")]),t._v(" "),a("p",[t._v("This is the part where you confirm your expectations. Aim for proprty based aspects instead of fixed values. This might mean you have to sharpen your knowledge of metaprogramming methods like "),a("code",[t._v("isinstance")]),t._v(".")]),t._v(" "),a("h2",{attrs:{id:"autoformatting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#autoformatting","aria-hidden":"true"}},[t._v("#")]),t._v(" Autoformatting")]),t._v(" "),a("p",[t._v("One of the best inventions in the last few years are autoformatters. I think it started with "),a("a",{attrs:{href:"https://golang.org/cmd/gofmt/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("gofmt")]),a("OutboundLink")],1),t._v(" but then that idea ported to javascript with "),a("a",{attrs:{href:"https://prettier.io/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("prettier")]),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("What it does is actually genius. It will compile your code down to the "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Abstract_syntax_tree",target:"_blank",rel:"noopener noreferrer"}},[t._v("AST"),a("OutboundLink")],1),t._v(" which is valid program devoid of whitespace, indents and other cruft. It then uses that to create your source code again in a consistent style that produces the same AST!")]),t._v(" "),a("p",[t._v("So to anyone that says \"I don't like things that change my code.\" Well, to a computer it hasn't changed.")]),t._v(" "),a("p",[t._v("Łukasz Langa, worked in the same office as the author of "),a("code",[t._v("prettier")]),t._v(" and created the equivalent program for python called "),a("code",[t._v("black")]),t._v(".")]),t._v(" "),a("p",[t._v("Here is his PyCon2019 talk about how it works if you are interested.")]),t._v(" "),a("p",[a("strong",[t._v("Łukasz Langa, Life Is Better Painted Black, or: How to Stop Worrying and Embrace Auto-Formatting")])]),t._v(" "),a("iframe",{attrs:{width:"560",height:"315",src:"https://www.youtube.com/embed/esZLCuWs_2Y",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""}}),t._v(" "),a("p",[t._v("To get up and running though it's simple:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pytest-black\npytest --black\n")])])]),a("p",[t._v("Or in your "),a("code",[t._v("pytest.ini")]),t._v(" or "),a("code",[t._v("tox.ini")]),t._v(" add the following:")]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[pytest]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("addopts")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")])]),t._v("\n  --black\n")])])]),a("h2",{attrs:{id:"linting-and-static-analysis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#linting-and-static-analysis","aria-hidden":"true"}},[t._v("#")]),t._v(" Linting and Static Analysis")]),t._v(" "),a("p",[t._v("Since Python is an interpretted language there is no formal compile step and a lot of errors don't appear until they are in production. Lucky for us static analysis is a very well understood field at this point and there are tools that will parse your code and look for patterns that exhibit a "),a("em",[t._v("code smell")]),t._v(" whilst it is not running.")]),t._v(" "),a("p",[t._v("Simple things like unused variables or import statements can be cleaned out.")]),t._v(" "),a("p",[t._v("But more sophisticated issues like the "),a("a",{attrs:{href:"https://en.wikipedia.org/wiki/Cyclomatic_complexity",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cyclomatic Complexity"),a("OutboundLink")],1),t._v(" of a function.")]),t._v(" "),a("p",[t._v("We are using "),a("a",{attrs:{href:"http://flake8.pycqa.org/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("flake8")]),a("OutboundLink")],1),t._v(". However "),a("a",{attrs:{href:"https://www.pylint.org/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pylint")]),a("OutboundLink")],1),t._v(" is a much more thorough tool but it also takes a full minute at minimum on even a small code base.")]),t._v(" "),a("p",[t._v("There are a few articles that discuss why "),a("code",[t._v("pylint")]),t._v(" is valuable but also the cost is speed.")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://pythonspeed.com/articles/pylint/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Why Pylint is both useful and unusable, and how you can actually use it"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://stackoverflow.com/questions/51488322/why-pylint-is-too-slow-while-pep8-just-takes-a-second-to-check-the-same-code",target:"_blank",rel:"noopener noreferrer"}},[t._v("Stackoverflow: Why Pylint is too slow while pep8 just takes a second to check the same code?"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("In the process of trying to get it to run faster I uncovered another issue when trying to roll out code quality to an existing code base.")]),t._v(" "),a("blockquote",[a("p",[t._v("Q: How do you eat an elephant?\nA: One mouthful at a time.")])]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("HEAD --name-only\n")])])]),a("p",[t._v("This will list all files that were changed in this branch ("),a("code",[t._v("HEAD")]),t._v(") relative to "),a("code",[t._v("master")]),t._v(".")]),t._v(" "),a("p",[t._v("Whilst I would not recommend "),a("code",[t._v("pylint")]),t._v(" on a day-to-day basis, I would recommend getting it's additional checks passing before opening a Pull Request.")]),t._v(" "),a("p",[t._v("So we added a stage to our CI pipeline that only lints modified files:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pylint "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" master"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("HEAD --name-only "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\.py$'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n")])])]),a("p",[t._v("Having come from a background of "),a("a",{attrs:{href:"https://www.typescriptlang.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Typescript"),a("OutboundLink")],1),t._v(" and seeing the benefits of working on an incrementally typed code base, I intend to roll out the use of "),a("a",{attrs:{href:"http://mypy-lang.org/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("mypy")]),a("OutboundLink")],1),t._v(". Most likely using "),a("em",[t._v("only modified on this branch")]),t._v(" trick to incrementally enforce it until we can use the "),a("a",{attrs:{href:"https://pypi.org/project/pytest-mypy/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-mypy")]),a("OutboundLink")],1),t._v(" plugin.")]),t._v(" "),a("p",[t._v("And this is the truly wonderful aspect of "),a("code",[t._v("pytest")]),t._v(", the use of plugins to tailor it to be the tool you need it to be and it's not bloated trying to be the tool you don't need.")]),t._v(" "),a("p",[t._v("Lucky for us, "),a("code",[t._v("flake8")]),t._v(" took the same approach and I have one more plugin "),a("a",{attrs:{href:"https://pypi.org/project/flake8-docstrings/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("flake8-docstrings")]),a("OutboundLink")],1),t._v(". Just so you are following along:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("pytest --\x3e pytest-flake8 --\x3e flake8 --\x3e flake8-docstrings\n")])])]),a("p",[t._v("It's plugins all the way down! Since docstrings are a language feature of Python they can be extracted and linted too! This plugin enforces the "),a("a",{attrs:{href:"https://www.python.org/dev/peps/pep-0257/",target:"_blank",rel:"noopener noreferrer"}},[t._v("PEP-257 Docstring Conventions"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("So this is the extra code:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pytest-flake8 flake8-docstrings\npytest --flake8\n")])])]),a("p",[a("code",[t._v("tox.ini")])]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[pytest]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("addopts")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" ")]),t._v("\n --black\n --flake8\n\n"),a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[flake8]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Default of 10 was too low for existing code base.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Ratcheted this up until existing code passes (20!)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Then each month dropped by 1 and have refactored back down to 15.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("max-complexity")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("15")]),t._v("\n")])])]),a("p",[t._v("Easy!")]),t._v(" "),a("h2",{attrs:{id:"code-coverage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#code-coverage","aria-hidden":"true"}},[t._v("#")]),t._v(" Code Coverage")]),t._v(" "),a("p",[t._v("Last section on automating code quality before we get into the meatier part of this article.")]),t._v(" "),a("p",[t._v("For the longest time I did not appreciate the value of testing and code coverage until a series of 3am "),a("a",{attrs:{href:"https://www.pagerduty.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("PagerDuty"),a("OutboundLink")],1),t._v(" events triggered and woke up me "),a("em",[t._v("and my wife")]),t._v(".")]),t._v(" "),a("p",[t._v("Back to "),a("em",[t._v("being stuck between "),a("strong",[t._v("the boss")]),t._v(" and a not so hard place")]),t._v(".")]),t._v(" "),a("p",[t._v("In my bleary eyed state I was manually running scripts to assert part of the system was or was not working as expected..... I was manually running tests. This could be automated, and so we did. We ran it early and ran it often. My wife and I have slept well since.")]),t._v(" "),a("blockquote",[a("p",[t._v("Q: So how much code coverage should I aim for?")]),t._v(" "),a("p",[t._v("A: 0% isn't really cutting it at the moment.")]),t._v(" "),a("p",[t._v("100% isn't practical or pragmatic.")]),t._v(" "),a("p",[t._v("Less than 50% doesn't inspire much confidence either.")]),t._v(" "),a("p",[t._v("So somewhere between 50-100% is our answer.")])]),t._v(" "),a("p",[t._v("Back in "),a("a",{attrs:{href:"#background-about-me"}},[t._v("background about me")]),t._v(" I mentioned that SalesForce enforces 75%. That means for every 4 lines of code, it is totally ok if one of them doesn't have test coverage. This is a calculated risk and thus the percentage should change depending on your situation.")]),t._v(" "),a("p",[t._v("You can get a lot of code coverage from 3-4 tests. Think of how when taking an MRI scan of the brain they'll inject an die so they can see which paths light up. You can get pretty good coverage from one test and when you layer a few together you get a better idea of what is happening.")]),t._v(" "),a("p",[t._v("I can usually hit 60-70% just by testing "),a("em",[t._v("The Happy Path")]),t._v(" of code execution and a few of "),a("em",[t._v("The Sad Paths")]),t._v(" of execution. If a bug crops up, well that is another sad path that you can add to your list of tests to cover.")]),t._v(" "),a("p",[t._v("We are using the "),a("a",{attrs:{href:"https://pytest-cov.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-cov")]),a("OutboundLink")],1),t._v(" plugin that leverages the "),a("a",{attrs:{href:"https://coverage.readthedocs.io/en/v4.5.x/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("coverage.py")]),a("OutboundLink")],1),t._v(" tool.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pytest-cov\n")])])]),a("p",[t._v("The configuration gets a bit hairy but just read my comments:\n"),a("code",[t._v("tox.ini")])]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[pytest]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("addopts")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Some other flags ommitted....")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Test Report")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  --junitxml")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("junit/test-results.xml")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Code Coverage")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  --cov")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(".")]),t._v("\n  --cov-branch\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("  # --no-cov-on-fail")]),t._v("\n  --cov-report xml:cov.xml\n  --cov-report html:htmlcov\n  --cov-report term\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("  # This value should be ratcheted up overtime as we get better coverage")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("  # Set at it's lowest point to prevent regressions")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  --cov-fail-under")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("68")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("  # Target:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("  # --cov-fail-under=75")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[coverage:run]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("omit")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" ")]),t._v("\n  **/test_*.py\n  **/__init__.py\n")])])]),a("p",[t._v("And here is some sample output:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("│- generated xml file: C:"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("jpeak"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("projects"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("kmap-python-lib"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("junit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("test-results.xml -\n│\n│----------- coverage: platform win32, python "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3.7")]),t._v(".3-final-0 -----------\n│Name                         Stmts   Miss Branch BrPart  Cover\n│--------------------------------------------------------------\n│koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("api.py                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%\n│koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("cache.py                "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),t._v("%\n│koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("config.py              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("98")]),t._v("%\n│koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("datawarehouse.py      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("101")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("21")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("22")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("77")]),t._v("%\n│koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("shorttermstore.py     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("230")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("106")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("70")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("48")]),t._v("%\n│--------------------------------------------------------------\n│TOTAL                          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("363")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("128")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("110")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("61")]),t._v("%\n│Coverage HTML written to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dir")]),t._v(" htmlcov\n│Coverage XML written to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" cov.xml\n│\n")])])]),a("p",[t._v("I'm currently working through the "),a("code",[t._v("shorttermstore")]),t._v(" wrapper but when I worked through the "),a("code",[t._v("datawarehouse")]),t._v(" code I realised something.")]),t._v(" "),a("blockquote",[a("p",[t._v("Increase code coverage by testing more code OR deleting code.")])]),t._v(" "),a("p",[t._v("So I refactored a lot of repetitive code and reduced the total number of lines of code as well as branch paths ("),a("code",[t._v("Branch")]),t._v(" and "),a("code",[t._v("BrPart")]),t._v("). I turned on "),a("code",[t._v("--cov-branch")]),t._v(" to make getting that percentage harder and more realistic as lines of code can be gamed.")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://martinfowler.com/books/refactoring.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Refactoring 2e - Martin Fowler"),a("OutboundLink")],1),t._v(" is a recommended read, even if it is only the first 5 chapters as they are the most critical.")]),t._v(" "),a("p",[t._v("Ok, deep breath. We made it this far and this is what I call the basics.")]),t._v(" "),a("p",[t._v("It's ok.")]),t._v(" "),a("p",[t._v("All of this, you setup at the start of a project or on an existing code base after you hire me.")]),t._v(" "),a("p",[t._v("I also call it the basics because you can add these stages to any software project in any language, it's a matter of doing what I did and google each of the headings plus your language's name.")]),t._v(" "),a("p",[t._v("Then it's automated and prompts you what to do when you haven't done it.")]),t._v(" "),a("p",[t._v("But I'm glad you have read this far.")]),t._v(" "),a("h1",{attrs:{id:"advanced-testing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#advanced-testing","aria-hidden":"true"}},[t._v("#")]),t._v(" Advanced Testing")]),t._v(" "),a("div",{attrs:{align:"center"}},[a("img",{attrs:{src:t.$withBase("/images/yo-dawg.jpg"),alt:"Yo Dawg Meme: Yo Dawg, We heard you like mocks; So we put some mocks in your mocks, and now you can mock mocks while you mocking.",height:"200"}})]),t._v(" "),a("p",[t._v("I've intentionally added a meme and some humour as a mental ad break as you may want to grab a coffee before the next section.")]),t._v(" "),a("p",[t._v("I sure did.")]),t._v(" "),a("h2",{attrs:{id:"fixtures"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fixtures","aria-hidden":"true"}},[t._v("#")]),t._v(" Fixtures")]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"https://docs.pytest.org/en/latest/fixture.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest")]),t._v(" Fixtures"),a("OutboundLink")],1),t._v(" documentation is actually really top quality.")]),t._v(" "),a("p",[t._v("But I really appreciated walking through Ch 3, 4, 5, 7 of "),a("a",{attrs:{href:"https://pragprog.com/book/bopytest/python-testing-with-pytest",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python testing with pytest - Brian Okken"),a("OutboundLink")],1),t._v(" that covers Fixtures, Builtin Fixtures, Plugins and other tools.")]),t._v(" "),a("p",[t._v("Lucky for you Prag Prog have a free excerpt from the "),a("a",{attrs:{href:"http://media.pragprog.com/titles/bopytest/fixtures.pdf",target:"_blank",rel:"noopener noreferrer"}},[t._v("Fixtures chapter"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Remember this example from the "),a("a",{attrs:{href:"#a-basic-test"}},[t._v("start")]),t._v("?")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pytest\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Config\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datawarehouse "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" DataWarehouse\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestDataWarehouse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fixture\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dwh_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parametrize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"names"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ids"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NamesOnly"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"All"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test_get_all_metrics")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Given")]),t._v("\n        dwh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" DataWarehouse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("envir"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# When")]),t._v("\n        results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dwh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_all_metrics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name_only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Then")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" results "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("isinstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("The fixture decorator marks this method for special use within the pytest eco-system. Once it is marked and available, you reference it in a pytest method signature like a function argument.")]),t._v(" "),a("p",[t._v("You can run the following to discover what fixtures are available:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pytest --fixtures\n")])])]),a("p",[t._v("In our test suite at Komatsu, most of our tests need to be configured to connect to databases. So it makes sense to create a single spot where it is setup (and torn down) but leverage using it multiple times. Should the database not be available, the fixture will throw an "),a("code",[t._v("ERROR")]),t._v(" to distinguish from your test "),a("code",[t._v("FAIL")]),t._v("ing.")]),t._v(" "),a("p",[t._v("In the example above I use a "),a("code",[t._v("return")]),t._v(" statement, but most fixtures will use a "),a("code",[t._v("yield")]),t._v(" statement.")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fixture")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("db_connection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Setup")]),t._v("\n    conn "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Database"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("yield")]),t._v(" conn\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Tear Down")]),t._v("\n    conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("close"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[a("code",[t._v("yield")]),t._v(" statements allow code to execute "),a("strong",[t._v("after")]),t._v(" the function initially returns. So when your test starts, it gets up to the "),a("code",[t._v("yield")]),t._v(" line in your fixture, before your test method starts. Once your test method completes the remainder of the code executes.")]),t._v(" "),a("p",[t._v("This is actually a really good segue to another useful plugin "),a("a",{attrs:{href:"https://pypi.org/project/pytest-mock/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-mock")]),a("OutboundLink")],1),t._v(" in the next section.")]),t._v(" "),a("h2",{attrs:{id:"mocks-spies-stubs-and-monkey-patches"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mocks-spies-stubs-and-monkey-patches","aria-hidden":"true"}},[t._v("#")]),t._v(" Mocks, Spies, Stubs and Monkey Patches")]),t._v(" "),a("h3",{attrs:{id:"monkey-patches"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#monkey-patches","aria-hidden":"true"}},[t._v("#")]),t._v(" Monkey Patches")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pytest\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Config\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestConfig")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test_bracket_accessors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" monkeypatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# given")]),t._v("\n        monkeypatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setenv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"KOALA_ENV"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pytest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("require_only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"KOALA_ENV"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# when")]),t._v("\n        results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"KOALA_ENV"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"koala_env"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Koala_Env"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# then")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pytest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pytest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pytest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n")])])]),a("p",[t._v("Our configuration class abides by the tenets of "),a("a",{attrs:{href:"https://12factor.net/config",target:"_blank",rel:"noopener noreferrer"}},[t._v("Twelve Factor Apps: Config"),a("OutboundLink")],1),t._v(" and expects configuration to be defined as environment variables.")]),t._v(" "),a("p",[t._v("I was using "),a("code",[t._v("os.environ")]),t._v(" directly but then that was modifying my global state and subesquent tests were not reliable, (and neither was my computer!).")]),t._v(" "),a("p",[t._v("The thing is when I ran "),a("code",[t._v("pytest koala/io/tests/test_config.py")]),t._v(" for quick iterations it worked but when I ran "),a("code",[t._v("pytest")]),t._v(" for the whole suite it broke. My tests only worked because of the order they ran and I would have found this earlier if I'd used "),a("a",{attrs:{href:"https://pypi.org/project/pytest-randomly/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-randomly")]),a("OutboundLink")],1),t._v(" which randomises the ordering of test execution.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pytest-randomly\n")])])]),a("p",[t._v("So I would have found this sooner, but how do I fix it? Well pytest has a builtin fixture for "),a("a",{attrs:{href:"https://docs.pytest.org/en/latest/monkeypatch.html#monkeypatching-environment-variables",target:"_blank",rel:"noopener noreferrer"}},[t._v("monkeypatching"),a("OutboundLink")],1),t._v(" even with an example monkey patching environment variables.")]),t._v(" "),a("blockquote",[a("p",[t._v("Hold on! What is this Monkey business?")])]),t._v(" "),a("p",[t._v("A monkey patch is a way to temporarily modify system behaviour.")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("monkeypatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("setenv"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"KOALA_ENV"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pytest"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),a("p",[t._v("This line ensures that for the duration of this test "),a("strong",[t._v("AND ONLY THIS TEST")]),t._v(" "),a("code",[t._v('os.environ["KOALA_ENV"]')]),t._v(" will return "),a("code",[t._v('"pytest"')]),t._v(".")]),t._v(" "),a("h3",{attrs:{id:"mocks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mocks","aria-hidden":"true"}},[t._v("#")]),t._v(" Mocks")]),t._v(" "),a("p",[t._v("I mentioned "),a("a",{attrs:{href:"https://pypi.org/project/pytest-mock/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-mock")]),a("OutboundLink")],1),t._v(", this uses the same principle of adding a fixture ("),a("code",[t._v("mocker")]),t._v(" in this case) that will automatically clean up your testing state. It includes monkey patching and some convenience methods for creating mocks, stubs and spies.")]),t._v(" "),a("p",[t._v("A "),a("a",{attrs:{href:"https://docs.python.org/3/library/unittest.mock.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("Mock")]),a("OutboundLink")],1),t._v(" is a very special Python object that you can swap it in for any other class, function or method and it will accept any method calls.")]),t._v(" "),a("p",[t._v("In it's default state it will do absolutely nothing at this point but let you capture "),a("em",[t._v("how")]),t._v(" a method was called and "),a("em",[t._v("how many times")]),t._v(" it was called. This gives us the option to design tests around these properties.")]),t._v(" "),a("h3",{attrs:{id:"stubs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stubs","aria-hidden":"true"}},[t._v("#")]),t._v(" Stubs")]),t._v(" "),a("p",[t._v("Stubs are like using a mock but you are usually returning a hard coded value instead of using the real method. Think of using a payment portal, you don't want to test sending money all the time but you want to test how your code behaves after it returns a value.")]),t._v(" "),a("p",[t._v("You can compose tests using the "),a("a",{attrs:{href:"http://doc.pytest.org/en/latest/parametrize.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("parametrizing"),a("OutboundLink")],1),t._v(" we mentioned earlier that can iterate through a hard coded list of scenarios that could return and put your response handlers through their motions.")]),t._v(" "),a("h3",{attrs:{id:"spies"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#spies","aria-hidden":"true"}},[t._v("#")]),t._v(" Spies")]),t._v(" "),a("p",[t._v("I personally think Spies are genius when you see how "),a("a",{attrs:{href:"https://pypi.org/project/pytest-mock/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-mock")]),a("OutboundLink")],1),t._v(" implement them in "),a("a",{attrs:{href:"https://github.com/pytest-dev/pytest-mock/blob/master/pytest_mock.py#L107",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("mocker.spy()")]),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("It is a Mock with a "),a("code",[t._v("side_effect")]),t._v(" of running the actual code.")]),t._v(" "),a("p",[t._v("So you can inject a spy into the flow of your normal code and access these extra execution properties about how often it was called and the history of arguments used to call it.")]),t._v(" "),a("h2",{attrs:{id:"be-kind-and-rewind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#be-kind-and-rewind","aria-hidden":"true"}},[t._v("#")]),t._v(" Be Kind and Rewind")]),t._v(" "),a("p",[t._v("Now that I have laid out all of that foundational knowledge — and to be honest it was a truck load that took me months to ramp up to — we add these lines:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" pytest-vcr\n")])])]),a("p",[a("code",[t._v("tox.ini")])]),t._v(" "),a("div",{staticClass:"language-ini extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token selector"}},[t._v("[pytest]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("addopts")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# PyVCR: HTTP Requests Fixture")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("  --vcr-record")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v("none")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ... other flags ...")]),t._v("\n")])])]),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pytest\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("config "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" Config\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" koala"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datawarehouse "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" DataWarehouse\n\nVCR_ARGS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("dict")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    filter_headers"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Authorization"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n    match_on"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"method"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scheme"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"host"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"port"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"path"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"query"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"headers"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"body"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestDataWarehouse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    \n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("fixture\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dwh_config")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("vcr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("VCR_ARGS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    @pytest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mark"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parametrize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"names"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ids"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"NamesOnly"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"All"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("test_get_all_metrics")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Given")]),t._v("\n        dwh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" DataWarehouse"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("envir"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("dwh_config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# When")]),t._v("\n        results "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" dwh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_all_metrics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name_only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Then")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" results "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("is")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("assert")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("isinstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("results"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("list")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),a("p",[t._v("Thanks to some "),a("em",[t._v("Twitter Driven Development")]),t._v(" I ran into "),a("a",{attrs:{href:"https://pypi.org/project/pytest-vcr/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-vcr")]),a("OutboundLink")],1),t._v(" which achieved what I needed to test our API wrappers in 4 lines of code (depending how you count it).")]),t._v(" "),a("p",[t._v("The decorator "),a("code",[t._v("@pytest.mark.vcr")]),t._v(" is all we need really. It creates a fixture that intercepts all HTTP traffic to our APIs only for the duration of a test. That is all requests and responses and I found out that some methods were making 3 API requests in a single test!")]),t._v(" "),a("p",[t._v("In our "),a("code",[t._v("tox.ini")]),t._v(" I set the default flag to "),a("code",[t._v("--vcr-record=none")]),t._v(" but initially I need to use "),a("code",[t._v("--vcr-record=once")]),t._v(" so it will save YAML files next to my test so it can be replayed.")]),t._v(" "),a("p",[t._v("The fact that I now have a cache makes these tests 10x faster not being blocked on network IO.")]),t._v(" "),a("p",[t._v("Now lets look at the "),a("code",[t._v("VCR_ARGS")]),t._v(" constant. VCR saves "),a("em",[t._v("all")]),t._v(" headers unless you "),a("code",[t._v("filter_headers")]),t._v(" and in particular the "),a("code",[t._v("Authorization")]),t._v(" header. Since I'm committing these YAML files to version control I do not want to store sensitive data. You should also filter out headers that are not test invariants, eg features that should reliably be properties of this request everytime like "),a("code",[t._v("nonce")]),t._v("s.")]),t._v(" "),a("p",[t._v("In our CI system the default behaviour uses the "),a("code",[t._v("--vcr-record=none")]),t._v(", which means VCR tries to match with existing YAML files and record no new requests.")]),t._v(" "),a("p",[t._v("The default matcher when looking up locally does not include matching the "),a("code",[t._v("headers")]),t._v(" and "),a("code",[t._v("body")]),t._v(", so I have enabled these in the "),a("code",[t._v("match_on")]),t._v(" initialisation.")]),t._v(" "),a("p",[t._v("Now, I can get "),a("code",[t._v("pytest-vcr")]),t._v(" to throw errors if there is a regression in how I compose a request! If it is a valid change to that test behaviour, I'll delete the YML file and record a new one.")]),t._v(" "),a("p",[t._v("This is the same idea behind "),a("a",{attrs:{href:"https://jestjs.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jest"),a("OutboundLink")],1),t._v(" where it takes snapshots of rendered Web Components as a snapshot reference for testing.")]),t._v(" "),a("p",[t._v("The part that VCR snapshot go beyond is that we essentially recorded stub data too so I can test the response handlers. I can copy a YML file and edit it to manually introduce response errors to test other pathways.")]),t._v(" "),a("p",[t._v("Now I'm only 24 hours into using "),a("code",[t._v("pytest-vcr")]),t._v(" and have a lot more to discover but what I'd like to see is the same sort of "),a("a",{attrs:{href:"https://github.com/pytest-dev/pytest-mock/#improved-reporting-of-mock-call-assertion-errors",target:"_blank",rel:"noopener noreferrer"}},[t._v("improved reporting of call assertions"),a("OutboundLink")],1),t._v(" from "),a("code",[t._v("pytest-mock")]),t._v(" when a request doesn't match locally but reports the diff of the nearest match.")]),t._v(" "),a("p",[t._v("Who knows, it might be a setting I'm missing, or it might mean I open a Pull Request.")]),t._v(" "),a("p",[t._v("Before I wrap up this section though I'd like to mention some plugins that were mentioned on twitter in this space:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/syrusakbary/snapshottest",target:"_blank",rel:"noopener noreferrer"}},[t._v("Snapshot test"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/getsentry/pytest-responses",target:"_blank",rel:"noopener noreferrer"}},[t._v("pytest-responses"),a("OutboundLink")],1)])]),t._v(" "),a("p",[a("strong",[t._v("UPDATE #1:")])]),t._v(" "),a("p",[t._v("After writing and publishing this article I found a deep and exhaustive collection of articles at "),a("a",{attrs:{href:"https://pythonspeed.com",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python Speed"),a("OutboundLink")],1),t._v(". In particular this one discussing the topic of "),a("em",[t._v("Verified Fakes")]),t._v(" which is kindof what "),a("a",{attrs:{href:"https://pypi.org/project/pytest-vcr/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-vcr")]),a("OutboundLink")],1),t._v(" is achieving around the python http library.")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://pythonspeed.com/articles/verified-fakes/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Verified Fakes"),a("OutboundLink")],1)])]),t._v(" "),a("p",[a("strong",[t._v("UPDATE #2:")])]),t._v(" "),a("p",[t._v("In an effort to create a local plugin to override the default exception thrown I went down "),a("a",{attrs:{href:"https://stackoverflow.com/questions/56745834/python-pytest-pytest-exception-interact-customize-exception-information-from-vcr",target:"_blank",rel:"noopener noreferrer"}},[t._v("this rabbit hole on stackoverflow"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("And subsequently opened "),a("a",{attrs:{href:"https://github.com/kevin1024/vcrpy/pull/445",target:"_blank",rel:"noopener noreferrer"}},[t._v("this pull request"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("So I can use the standard library "),a("a",{attrs:{href:"https://docs.python.org/3/library/difflib.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("difflib")]),a("OutboundLink")],1),t._v(" to create a diff of why the attempted request did not match the recorded request for that specific test.")]),t._v(" "),a("p",[a("strong",[t._v("UPDATE #3:")])]),t._v(" "),a("p",[t._v("In a weird turn of events I finally managed to "),a("a",{attrs:{href:"https://stackoverflow.com/a/56828754/622276",target:"_blank",rel:"noopener noreferrer"}},[t._v("answer my question on stackoverflow"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("In the mean time I met "),a("a",{attrs:{href:"https://github.com/arthurHamon2",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("arthurHamon2")]),a("OutboundLink")],1),t._v(" who was attempting to do the same thing in "),a("a",{attrs:{href:"https://github.com/kevin1024/vcrpy/pull/439",target:"_blank",rel:"noopener noreferrer"}},[t._v("PR #439"),a("OutboundLink")],1),t._v(" of "),a("a",{attrs:{href:"https://vcrpy.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("vcrpy")]),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[t._v("Also "),a("code",[t._v("kevin1024")]),t._v(" granted myself and "),a("code",[t._v("arthurHamon2")]),t._v(" maintainer privileges.")]),t._v(" "),a("p",[t._v("And finally... there was a bug only showing on CI and not on local dev. Turns out our timestamp functions were using the system timezone and converting it in ways we weren't expecting and would never have known if we were not doing this sort of reproducible testing.")]),t._v(" "),a("h1",{attrs:{id:"conclusion"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#conclusion","aria-hidden":"true"}},[t._v("#")]),t._v(" Conclusion")]),t._v(" "),a("p",[t._v("Code quality plugins like "),a("a",{attrs:{href:"https://github.com/shopkeep/pytest-black",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-black")]),a("OutboundLink")],1),t._v(" and "),a("a",{attrs:{href:"https://pypi.org/project/pytest-flake8/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-flake8")]),a("OutboundLink")],1),t._v(" automatically add source files as a linting test that will fail CI but also skip the test if that file hasn't been modified between runs. This caching drops the first test run from 71 seconds to 44 seconds.")]),t._v(" "),a("p",[t._v("With the help of "),a("a",{attrs:{href:"https://pypi.org/project/pytest-xdist/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-xdist")]),a("OutboundLink")],1),t._v(" I was able to spread our tests across multiple processes and reduced our total test suite time from 44 seconds to 14 seconds.")]),t._v(" "),a("p",[t._v("With the help of the "),a("a",{attrs:{href:"https://pypi.org/project/pytest-vcr/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-vcr")]),a("OutboundLink")],1),t._v(" plugin I was able to mock out our HTTP traffic in our API test wrappers. This cached response reduced the tests from 14 seconds to 1.4 seconds.")]),t._v(" "),a("p",[t._v("So reducing cycle time to answer questions means we can learn faster. The time it takes for your team to triage bugs and assert truths and expectations means other tasks come down from weeks to days or hours to seconds.")]),t._v(" "),a("p",[a("strong",[t._v("BONUS:")]),t._v(" We were able to detect a rather subtle bug because of the snapshot testing (and newly improved diffing features) of "),a("a",{attrs:{href:"https://vcrpy.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("vcrpy")]),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Have fun testing!")]),t._v(" "),a("h1",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references","aria-hidden":"true"}},[t._v("#")]),t._v(" References")]),t._v(" "),a("h2",{attrs:{id:"tools"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#tools","aria-hidden":"true"}},[t._v("#")]),t._v(" Tools")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://doc.pytest.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Pytest"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://tox.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tox"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://black.readthedocs.io/en/stable/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Black"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://flake8.pycqa.org/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flake8"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://coverage.readthedocs.io/en/v4.5.x/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Coverage.py"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.pipenv.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("pipenv"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://mypy-lang.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("mypy"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"pytest-plugins"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pytest-plugins","aria-hidden":"true"}},[t._v("#")]),t._v(" Pytest Plugins")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/shopkeep/pytest-black",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-black")]),a("OutboundLink")],1),t._v(": Enforce formatting style "),a("a",{attrs:{href:"https://black.readthedocs.io/en/stable/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("black")]),a("OutboundLink")],1),t._v(" as a test")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pypi.org/project/pytest-flake8/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-flake8")]),a("OutboundLink")],1),t._v(": Enforce linting standard "),a("a",{attrs:{href:"http://flake8.pycqa.org/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("flake8")]),a("OutboundLink")],1),t._v(" as a test")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pytest-cov.readthedocs.io/en/latest/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-cov")]),a("OutboundLink")],1),t._v(": Measure and enforce code coverage (> 75%) "),a("a",{attrs:{href:"https://coverage.readthedocs.io/en/v4.5.x/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("coverage.py")]),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pypi.org/project/pytest-mock/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-mock")]),a("OutboundLink")],1),t._v(": Test fixture to assist mocking and monkey patching")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pypi.org/project/pytest-vcr/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-vcr")]),a("OutboundLink")],1),t._v(": Record and replay HTTP requests as a test fixture ("),a("a",{attrs:{href:"https://vcrpy.readthedocs.io/en/latest/index.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("VCR.py")]),a("OutboundLink")],1),t._v(")")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pypi.org/project/pytest-randomly/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-randomly")]),a("OutboundLink")],1),t._v(": Run tests in random order to detect leaking global state")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pypi.org/project/pytest-xdist/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-xdist")]),a("OutboundLink")],1),t._v(": Distribute tests across multiple CPU cores (or compute nodes)")])]),t._v(" "),a("p",[t._v("Others but untested:")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/syrusakbary/snapshottest",target:"_blank",rel:"noopener noreferrer"}},[t._v("Snapshot test"),a("OutboundLink")],1),t._v(": Inspired by "),a("a",{attrs:{href:"https://jestjs.io/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jest"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/getsentry/pytest-responses",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("pytest-responses")]),a("OutboundLink")],1),t._v(": pytest fixture for mocking out the requests library")])]),t._v(" "),a("h2",{attrs:{id:"podcasts-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#podcasts-2","aria-hidden":"true"}},[t._v("#")]),t._v(" Podcasts")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://talkpython.fm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Talk Python To Me"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://testandcode.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Test and Code"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://pythonbytes.fm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python Bytes"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"books"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#books","aria-hidden":"true"}},[t._v("#")]),t._v(" Books")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://pragprog.com/book/bopytest/python-testing-with-pytest",target:"_blank",rel:"noopener noreferrer"}},[t._v("Python Testing with pytest - Brian Okken (Pragmatic Programmer Publishing)"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"articles"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#articles","aria-hidden":"true"}},[t._v("#")]),t._v(" Articles")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://realpython.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python"),a("OutboundLink")],1),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://realpython.com/pypi-publish-python-package/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Packaging a Python Library"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/pipenv-guide/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: A guide to Pipenv"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/python-testing/#testing-in-multiple-environments",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Automated Testing - Multiple Environments"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://realpython.com/python-mock-library/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Real Python: Python Mock Library"),a("OutboundLink")],1)])])])])])},[],!1,null,null,null);e.default=n.exports}}]);