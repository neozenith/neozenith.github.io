<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>From Zero to Test: Turning hurdles into steps. | Josh Peak - ☕ Release Valve</title>
    <meta name="description" content="A few basic principles on testing to overcome that initial &#39;wall of daunting&#39; and have a framework for successes.">
    <link rel="icon" href="/images/favicon.ico">
    <meta property="og:image" content="/images/books.jpg"><meta property="og:image:type" content="undefined"><meta property="og:image:width" content="undefined"><meta property="og:image:height" content="undefined"><meta property="og:image:alt" content="undefined"><meta name="twitter:image" content="/images/books.jpg"><meta itemprop="image" content="/images/books.jpg"><meta property="og:description" content="A few basic principles on testing to overcome that initial &#39;wall of daunting&#39; and have a framework for successes."><meta name="twitter:description" content="A few basic principles on testing to overcome that initial &#39;wall of daunting&#39; and have a framework for successes."><meta itemprop="description" content="A few basic principles on testing to overcome that initial &#39;wall of daunting&#39; and have a framework for successes."><meta property="og:url" content="https://joshpeak.net/posts/2019-07-22-from-zero-to-test.html"><meta name="twitter:url" content="https://joshpeak.net/posts/2019-07-22-from-zero-to-test.html"><meta property="og:title" content="From Zero to Test: Turning hurdles into steps."><meta name="twitter:title" content="From Zero to Test: Turning hurdles into steps."><meta itemprop="name" content="From Zero to Test: Turning hurdles into steps."><meta property="og:type" content="article"><meta name="twitter:card" content="summary"><meta property="og:site_name" content="Josh Peak - Data Scientist">
    <link rel="preload" href="/assets/css/0.styles.28cdc2b5.css" as="style"><link rel="preload" href="/assets/js/app.80a7528a.js" as="script"><link rel="preload" href="/assets/js/2.aba1241c.js" as="script"><link rel="preload" href="/assets/js/15.ca05cee3.js" as="script"><link rel="prefetch" href="/assets/js/10.f3453583.js"><link rel="prefetch" href="/assets/js/11.832aa524.js"><link rel="prefetch" href="/assets/js/12.5c48ea3e.js"><link rel="prefetch" href="/assets/js/13.e908bfb0.js"><link rel="prefetch" href="/assets/js/14.49a54d24.js"><link rel="prefetch" href="/assets/js/16.c5702788.js"><link rel="prefetch" href="/assets/js/17.3f4992c9.js"><link rel="prefetch" href="/assets/js/18.f6dce9fc.js"><link rel="prefetch" href="/assets/js/19.ff3ad037.js"><link rel="prefetch" href="/assets/js/3.cad2f620.js"><link rel="prefetch" href="/assets/js/4.7c0fc933.js"><link rel="prefetch" href="/assets/js/5.7c16fa7c.js"><link rel="prefetch" href="/assets/js/6.b9fd97c8.js"><link rel="prefetch" href="/assets/js/7.61e65139.js"><link rel="prefetch" href="/assets/js/8.ff941761.js"><link rel="prefetch" href="/assets/js/9.44dced01.js">
    <link rel="stylesheet" href="/assets/css/0.styles.28cdc2b5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Josh Peak - ☕ Release Valve</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">Posts</a></div><div class="nav-item"><a href="https://au.linkedin.com/in/neozenith" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinkedIn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/neozenith" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/posts/" class="nav-link router-link-active">Posts</a></div><div class="nav-item"><a href="https://au.linkedin.com/in/neozenith" target="_blank" rel="noopener noreferrer" class="nav-link external">
  LinkedIn
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/neozenith" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/" class="nav-link">About</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><div align="center"><img src="/images/books.jpg" alt="Reference books on my desk"></div> <h1 id="page-title"><a href="#page-title" class="header-anchor">#</a> From Zero to Test: Turning hurdles into steps.</h1> <p><span style="color:#999;">14 min read...</span></p> <p>I strongly believe you can do a lot with very little when developing software and you don't have to know 100% to have learnt enough to be effective.</p> <p>The same is true when automating tests.</p> <p>This article will layout a few maxims, you can go from <strong>0% effective at testing</strong> to <strong>~80% effective at testing</strong>.</p> <p>The <a href="https://en.wikipedia.org/wiki/Pareto_principle" target="_blank" rel="noopener noreferrer">Pareto Principle<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is also called the 80/20 rule. You get 80% of the effect from 20% of the effort, whilst the last 20% of effect requires <em>the other 80% effort</em>. This is of course annecdotal but you get the point. Throughout this article I will try to link to resources if you want to read further about <em>the other 80%</em> after you have whet your appetite.</p> <p>Ok, here are the maxims:</p> <ol><li><a href="#given-when-then"><strong>Given-When-Then</strong></a>: Every test has three easy to remember steps (and they rhyme!).</li> <li><a href="#happy-paths-and-sad-paths"><strong>Happy Paths and Sad Paths</strong></a>: When should it work? How should it break?</li> <li><a href="#inner-loop-vs-outer-loop"><strong>Inner Loop vs Outer Loop</strong></a>: Fast Focused testing (milliseconds) and Coffee Break Comprehensive (minutes).</li> <li><a href="#refactoring-less-is-more"><strong>Refactoring: Less is More</strong></a>: You could write more tests or you could DRY out the code.</li></ol> <h1 id="given-when-then"><a href="#given-when-then" class="header-anchor">#</a> Given-When-Then</h1> <p>Here is a simple sample test I covered in my other article <a href="/posts/2019-06-18-Advanced-python-testing.html">Advanced Python Testing</a> but you don't have to understand what it does, just the anatomy.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> pytest
<span class="token keyword">from</span> koala<span class="token punctuation">.</span>io<span class="token punctuation">.</span>config <span class="token keyword">import</span> Config
<span class="token keyword">from</span> koala<span class="token punctuation">.</span>io<span class="token punctuation">.</span>datawarehouse <span class="token keyword">import</span> DataWarehouse

<span class="token keyword">class</span> <span class="token class-name">TestDataWarehouse</span><span class="token punctuation">:</span>
    
    @pytest<span class="token punctuation">.</span>fixture
    <span class="token keyword">def</span> <span class="token function">dwh_config</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Config<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">test_get_all_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dwh_config<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Given</span>
        dwh <span class="token operator">=</span> DataWarehouse<span class="token punctuation">(</span>envir<span class="token operator">=</span>dwh_config<span class="token punctuation">)</span>

        <span class="token comment"># When</span>
        results <span class="token operator">=</span> dwh<span class="token punctuation">.</span>get_all_metrics<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Then</span>
        <span class="token keyword">assert</span> results <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>

</code></pre></div><p>Here the test is <code>test_get_all_metrics</code>.</p> <p>It pulls in the <code>dwh_config</code> <a href="/posts/2019-06-18-Advanced-python-testing.html#fixtures">fixture</a> which I covered in my other post but you can ignore for now.</p> <p>The key practice that makes testing really really easy is the <em>Given/When/Then</em> framework which makes the process of writing tests calmingly methodic and digestable.</p> <h3 id="given"><a href="#given" class="header-anchor">#</a> Given</h3> <p>Everything I need to setup the variables, states, conditions and databases etc to successfully <em>reproduce</em> a test <em>in isolation</em>.</p> <p>This can consist of test data but also of setting up a database connection using fixtures. The distinction I like is that fixtures return <code>ERROR</code>s where as tests throw <code>FAIL</code>s.</p> <p>This is handy, when I run my test suite, <code>FAIL</code>s mean my code is broken and this is important. <code>ERROR</code>s are bad but a different kind of bad. Which means production code doesn't have a fault, just our test suite design which is less critical and time sensitive. I don't know about you but this distinction actually reduces my stress levels a little.</p> <p>It also make the rest of the test clean and easy to see.</p> <p>To extend yourself on <em>the other 80%</em> read the following topics:</p> <ul><li><a href="https://docs.pytest.org/en/latest/fixture.html" target="_blank" rel="noopener noreferrer">Pytest Fixtures: Explicit, modular, scalable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://martinfowler.com/bliki/TestDouble.html" target="_blank" rel="noopener noreferrer">Martin Fowler: Test Doubles<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://martinfowler.com/articles/mocksArentStubs.html" target="_blank" rel="noopener noreferrer">Martin Fowler: Mocks Aren't Stubs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="when"><a href="#when" class="header-anchor">#</a> When</h3> <p>The part of the code under test. I try to make this section one line of code so it is really clear what is being tested and how a user would write the same line of code.</p> <p>It forces me to think about the Developer Experience (DX) of the API design.</p> <h3 id="then"><a href="#then" class="header-anchor">#</a> Then</h3> <p>This is the part where you confirm your expectations. Aim for property based aspects instead of fixed values. This might mean you have to sharpen your knowledge of metaprogramming methods like <code>isinstance</code>.</p> <p>Diving deeper into what metaprogramming properties you can leverage is <em>the other 80% of effort</em> that gets you the last 20%.</p> <p>Extend yourself further with topics like the following:</p> <ul><li>Statistical testing - &quot;The website loads under 1s 99% of the time.&quot; allows confidence with measurable uncertainty
<ul><li><a href="hypothesis">hypothesis</a></li></ul></li> <li>Snapshot testing - Record a result as a truth to detect regressions.
<ul><li><a href="https://vcrpy.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">VCRpy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/syrusakbary/snapshottest" target="_blank" rel="noopener noreferrer">Snapshot test<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/getsentry/pytest-responses" target="_blank" rel="noopener noreferrer"><code>pytest-responses</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li> <li>Mutation testing</li> <li>Many more... I'm still learning these myself.</li></ul> <h1 id="happy-paths-and-sad-paths"><a href="#happy-paths-and-sad-paths" class="header-anchor">#</a> Happy Paths and Sad Paths</h1> <h2 id="happy-paths"><a href="#happy-paths" class="header-anchor">#</a> Happy Paths</h2> <p>This is pretty easy and likely the minimal amount of testing you'll want to write.</p> <p>When everything is going well, what can we assert about the system that we would know it is working?</p> <p>Before automated testing, what would you run manually and check to know it worked? Could you encode that in a script? Yes. The answer is usually yes.</p> <p>Now the next developer can leverage your test automation. More often that not, the <em>next developer</em> is you. Do your future self a favour.</p> <h2 id="sad-paths"><a href="#sad-paths" class="header-anchor">#</a> Sad Paths</h2> <blockquote><p>A QA engineer walks into a bar.</p> <p>Orders a beer.</p> <p>Orders 0 beers.</p> <p>Orders 99999999999 beers.</p> <p>Orders a lizard.</p> <p>Orders -1 beers.</p> <p>Orders a ueicbksjdhd.</p> <p>First real customer walks in and asks where the bathroom is. The bar bursts into flames, killing everyone.</p></blockquote> <p><a href="https://twitter.com/brenankeller/status/1068615953989087232?lang=en" target="_blank" rel="noopener noreferrer">Brenan Keller - Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Ok the first test case is a happy path ordering a beer. The next 5 are <em>Sad Paths</em> where we try to safely handle failures of the system.</p> <p>The key is to check for:</p> <ul><li>uninitialised, null values or 0s</li> <li>large values</li> <li>invalid data types</li> <li>negative values</li> <li>random unexpected inputs</li></ul> <p>If you want to read further on this topic there are tools called <a href="https://faker.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">Faker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://hypothesis.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Hypothesis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> if you want to generate fake data for testing. The idea is that if you throw random subsamples of data at your tests, over time you will have covered a robust distribution of corner cases you never would have thought of manually.</p> <p>I'd like to add in here InfoSec/SecOps tests. You put locks on your house? You don't leave your keys on the front porch? Some basic tests around your authentication can prevent some embarrassing regressions.</p> <p>The last line about the bathroom is also an <em>Untested Sad Path</em>.</p> <h2 id="untested-sad-paths"><a href="#untested-sad-paths" class="header-anchor">#</a> Untested Sad Paths</h2> <p>When you have a bug report come in, this is a sad path we didn't catch. That's ok.</p> <p>We have a framework for writing a reproducible test to replicate the bug and ensure our fix stays fixed.</p> <p>I have seen bugs re-introduced, when simply adding to the catalog of sad paths would have caught it.</p> <p>Setting up the testing framework, is the 20% that allows adding the last 80% to be so much easier and grow over time.</p> <h1 id="inner-loop-vs-outer-loop"><a href="#inner-loop-vs-outer-loop" class="header-anchor">#</a> Inner Loop vs Outer Loop</h1> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Outer Loop&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Inner Loop&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>The idea is that your <em>Inner Loop</em> should take milliseconds and cost the least amount of time because quickly iterating is the most important task and you'll likely do this 1000x for every time you run your outer loop.</p> <p>The <em>Outer loop</em> test is more comprehensive and the reason why many people claim &quot;tests take too long to run&quot;.
Wait... are you running your outer loop as your inner loop?</p> <h2 id="inner-loop"><a href="#inner-loop" class="header-anchor">#</a> Inner Loop</h2> <p>Most of the time I'm working on a single test so I should run only that test.</p> <p><strong>Single Test</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_get_all_metrics

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">1</span> passed <span class="token keyword">in</span> <span class="token number">0.57</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>Which is different to the following which takes longer even if it is under 1 second:</p> <p><strong>Test Suite</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">15</span> passed, <span class="token number">2</span> skipped <span class="token keyword">in</span> <span class="token number">0.94</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>I have snapshot testing on (<a href="https://vcrpy.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">VCRpy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>) which doesn't hit the real test datawarehouse. So the <code>--disable-vcr</code> is a non-standard pytest flag. You will need <a href="https://pypi.org/project/pytest-vcr/" target="_blank" rel="noopener noreferrer"><code>pytest-vcr</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>Integration tests</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py --disable-vcr
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">15</span> passed, <span class="token number">2</span> skipped <span class="token keyword">in</span> <span class="token number">48.91</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
</code></pre></div><p>You see how network intensive these tests are? That is 50x slower and adds up.</p> <p>This is where we delegate full integration testing to the <em>Outer Loop</em> but we can make use of <em>Snapshot Testing</em> as a proxy for fast <em>Inner Loop</em> testing workflows. And thats important... its a workflow, not a rule.</p> <p>But I'm writing this up because not many people know its an option.</p> <p><strong>Markers as Filters</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py --disable-vcr -m <span class="token string">&quot;not vcr&quot;</span>

koala/io/tests/test_datawarehouse.py::FLAKE8 SKIPPED                     <span class="token punctuation">[</span> <span class="token number">25</span>%<span class="token punctuation">]</span>
koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_default_initialisation PASSED <span class="token punctuation">[</span> <span class="token number">50</span>%<span class="token punctuation">]</span>
koala/io/tests/test_datawarehouse.py::BLACK SKIPPED                      <span class="token punctuation">[</span> <span class="token number">75</span>%<span class="token punctuation">]</span>
koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_legacy_initialisation_error PASSED <span class="token punctuation">[</span><span class="token number">100</span>%<span class="token punctuation">]</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">2</span> passed, <span class="token number">2</span> skipped, <span class="token number">13</span> deselected <span class="token keyword">in</span> <span class="token number">0.61</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
</code></pre></div><p>Here is a way I can find tests I haven't used <a href="https://vcrpy.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreferrer">VCRpy<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> on for snapshot testing. Looks like these tests aren't reaching out to the network anyhow. Black and Flake8 automatically skip since the file has not been modified since it last passed so that saves precious milliseconds when we are doing this 1000x times a day.</p> <p><strong>Keyword Filters</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py -k metrics

koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_get_all_metrics<span class="token punctuation">[</span>All<span class="token punctuation">]</span> PASSED <span class="token punctuation">[</span> <span class="token number">33</span>%<span class="token punctuation">]</span>
koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_create_metrics PASSED <span class="token punctuation">[</span> <span class="token number">66</span>%<span class="token punctuation">]</span>
koala/io/tests/test_datawarehouse.py::TestDataWarehouse::test_get_all_metrics<span class="token punctuation">[</span>NamesOnly<span class="token punctuation">]</span> PASSED <span class="token punctuation">[</span><span class="token number">100</span>%<span class="token punctuation">]</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">3</span> passed, <span class="token number">14</span> deselected <span class="token keyword">in</span> <span class="token number">0.67</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>This matches on substrings in the test node ID to help filter to a subset of all tests keeping us focused and getting answers in under 1 second. It also means I can gather and combine related tests to customise my Inner Loop on the fly.</p> <p><strong>Last Failed / First Failure</strong></p> <p>Next I'm going to introduce a failure which impacts a lot of tests and turn off traceback info.</p> <p>I can't show you the failure I introduced but it is systemic because it was a URL which still a valid URL but does not match our snapshot. So it is still a valid fixture which is why it isn't throwing an <code>ERROR</code>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py --tb<span class="token operator">=</span>no
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">13</span> failed, <span class="token number">4</span> passed <span class="token keyword">in</span> <span class="token number">2.62</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>Since there are so many lets just work through them one at a time and stop on the <strong>First Failed</strong>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py --tb<span class="token operator">=</span>no -x

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">1</span> failed <span class="token keyword">in</span> <span class="token number">0.68</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>This is a pretty good filter, to help chip away at a list of failures but stay focused. If there are no previous failures it just runs all tests within our filter. This is handy to use with <code>--pdb</code> to drop into the debugger too.</p> <p>For completeness I like using the <code>--last-failed</code> or <code>--lf</code> flag to focus on the most recently introduced failures.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest koala/io/tests/test_datawarehouse.py --tb<span class="token operator">=</span>no --lf

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">13</span> failed, <span class="token number">4</span> deselected <span class="token keyword">in</span> <span class="token number">1.97</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>There you have it. These are the ways that <a href="https://doc.pytest.org/" target="_blank" rel="noopener noreferrer">PyTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> allows you to filter and focus on tests but I'd guarantee any other testing framework would have an equivalent set of features for inner loop test runs just begging to be discovered in their docs.</p> <h2 id="outer-loop"><a href="#outer-loop" class="header-anchor">#</a> Outer Loop</h2> <p>This is the longest but also the most comprehensive part of the test loop which is why we do it less frequently. We are balancing time costs.</p> <p>Knowing you have vastly cheaper options with your inner loop tests, means you can leave these more time expensive tests to run at  lower frequency like coffee breaks, morning tea, lunch time, or overnight on CI.</p> <p>Part of the reason they are time intensive are:</p> <ul><li>The base volume of tests</li> <li>Combinatorial explosion of testing across versions of python / OS (<em>See <a href="https://tox.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">Tox<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em>)</li> <li>Slow io: Network / Disk interactions</li> <li>Unnecessarily rerunning tests</li> <li>Running all tests serially</li></ul> <p>The first two are hard to avoid other than cutting support for old platforms.</p> <p>The last three can be improved. For example:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest --cache-clear --disable-vcr
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">3</span> failed, <span class="token number">167</span> passed, <span class="token number">5</span> skipped <span class="token keyword">in</span> <span class="token number">237.10</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token comment"># Versus</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">104</span> passed, <span class="token number">71</span> skipped <span class="token keyword">in</span> <span class="token number">33.75</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>First off, this shows why snapshot testing is only a proxy as it hid three failures when testing against the real system. This is a <strong>Type II error or a False Negative</strong>. These are dangerous as they lull you into a false sense of security that everything is ok when it isn't.</p> <p>In this case that service was down and is known to be flaky. Which is why I put the snapshot testing in place.
The fact that service is flaky creates a <strong>Type I error or a False Positive</strong>. Which in a lot of ways are as bad as Type II errors when people do not trust the tests and then stop writing tests.</p> <p>The goal is to reduce both. The other ~170 tests give me confidence about the rest of the system and I can isolate my mistrust.</p> <h2 id="outer-loop-speed-tuning"><a href="#outer-loop-speed-tuning" class="header-anchor">#</a> Outer Loop Speed Tuning</h2> <p><strong>Parallelisation</strong>: To get our outer loop running faster we can run all tests in parallel rather than sequentially using <a href="https://pypi.org/project/pytest-xdist/" target="_blank" rel="noopener noreferrer"><code>pytest-xdist</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This means your tests need to be able to run isolated from each other. Which means all tests are not blocked by a single test and we are limited to available cores. But it means tests that take 30 seconds each are running at the same time and not after each other.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest --cache-clear --disable-vcr -n auto
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">2</span> failed, <span class="token number">168</span> passed, <span class="token number">5</span> skipped <span class="token keyword">in</span> <span class="token number">56.79</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>See, I told you some of the tests are flaky. One of them started passing again.</p> <p><strong>Caching</strong></p> <p>Then simply allowing black and flake8 checks to skip if the source file is unmodified.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest --disable-vcr -n auto
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> <span class="token number">3</span> failed, <span class="token number">97</span> passed, <span class="token number">75</span> skipped <span class="token keyword">in</span> <span class="token number">56.98</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>Huh... that didn't make much difference. Now the data scientist in me wants to run these 30x each and perform a t-test to actually be thorough... another time.</p> <p><strong>Snapshot tests / Test Doubles</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest -n auto
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span> <span class="token number">100</span> passed, <span class="token number">75</span> skipped <span class="token keyword">in</span> <span class="token number">34.34</span> seconds <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
</code></pre></div><p>By using Test Doubles we can mock IO bound operations that spend most of the test waiting for the speed of light to travel around the planet to a cloud.</p> <p>As fast as this may be it is still 100x slower than our Inner Loop.</p> <p>Finally if you want to find the slowest tests run the following:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>pytest --durations<span class="token operator">=</span><span class="token number">2</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> slowest <span class="token number">2</span> <span class="token builtin class-name">test</span> durations <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token number">23</span>.31s call     koala/io/tests/test_redis.py::TestRedis::test_redis_get_keys
<span class="token number">19</span>.08s call     koala/io/tests/test_redis.py::TestRedis::test_redis_get_filtered_keys
</code></pre></div><p>Pytest measures the running time of each individual test automatically.</p> <h1 id="refactoring-less-is-more"><a href="#refactoring-less-is-more" aria-hidden="true" class="header-anchor">#</a> Refactoring: Less is More</h1> <p>I was migrating some legacy code and trying to hit a minimum amount of code coverage when I realised:</p> <blockquote><p>I could increase code coverage by testing more code</p> <p>OR</p> <p>deleting code....</p></blockquote> <p>I had already written all of the <em>Happy Path</em> tests and most of the <em>Sad Paths</em> but the number of branches and code paths was pretty complex and seemed like it was going to take weeks until I realised a lot of code was copy pasted.</p> <p>There was 30x places we copy-pasted very similar code to check how we made requests to an API. So I made it a function and deleted the other 29x instances for the function 1-liner. Neater code! Easier to reason with.</p> <p><a href="https://martinfowler.com/books/refactoring.html" target="_blank" rel="noopener noreferrer">Refactoring 2e - Martin Fowler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a recommended read, even if it is only the first 5 chapters as they are the most critical.</p> <p>Martin Fowler maintains a <a href="https://refactoring.com/catalog/?filter=tags-basic" target="_blank" rel="noopener noreferrer">catalog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of refactoring patterns and has kindly given them names to make conveying these concepts easier.</p> <p>If nothing else I'd like you to understand <a href="https://refactoring.com/catalog/extractFunction.html" target="_blank" rel="noopener noreferrer">Extract Function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which is what I used above.</p> <p>This can be applied to:</p> <ul><li>the inside of a loop</li> <li>the inside of an if block</li> <li>inside the <code>try</code> block of a <code>try-except</code></li> <li>inside the <code>except</code> clause of a <code>try-except</code></li> <li>repeated blocks of code</li></ul> <p>That block of code can be reused.</p> <p>And often I only see what others have copy pasted when I get to this stage of testing and take a step back and look at the module holistically.</p> <p>Another good reason to get everyone on your team writing tests right?</p> <h1 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h1> <ol><li><a href="#given-when-then"><strong>Given-When-Then</strong></a>: Every test has three easy to remember steps (and they rhyme!).</li> <li><a href="#happy-paths-and-sad-paths"><strong>Happy Paths and Sad Paths</strong></a>: When should it work? How should it break?</li> <li><a href="#inner-loop-vs-outer-loop"><strong>Inner Loop vs Outer Loop</strong></a>: Fast Focused testing (milliseconds) and Coffee Break Comprehensive (minutes).</li> <li><a href="#refactoring-less-is-more"><strong>Refactoring: Less is More</strong></a>: You could write more tests or you could DRY out the code.</li></ol> <p>Have fun testing!</p> <h1 id="extensions"><a href="#extensions" aria-hidden="true" class="header-anchor">#</a> Extensions</h1> <ol><li><a href="https://en.wikipedia.org/wiki/Test_double" target="_blank" rel="noopener noreferrer">Test Doubles<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://kentcdodds.com/blog/effective-snapshot-testing" target="_blank" rel="noopener noreferrer">Effective Snapshot Testing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://hypothesis.works/articles/what-is-property-based-testing/" target="_blank" rel="noopener noreferrer">Property Based Testing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://en.wikipedia.org/wiki/Fuzzing" target="_blank" rel="noopener noreferrer">Fuzzing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://refactoring.com/catalog/?filter=tags-basic" target="_blank" rel="noopener noreferrer">Refactoring<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <h1 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h1> <h2 id="podcasts"><a href="#podcasts" aria-hidden="true" class="header-anchor">#</a> Podcasts</h2> <ul><li><a href="https://talkpython.fm/" target="_blank" rel="noopener noreferrer">Talk Python To Me<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://testandcode.com/" target="_blank" rel="noopener noreferrer">Test and Code<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://pythonbytes.fm/" target="_blank" rel="noopener noreferrer">Python Bytes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="books"><a href="#books" aria-hidden="true" class="header-anchor">#</a> Books</h2> <ul><li><a href="https://pragprog.com/book/bopytest/python-testing-with-pytest" target="_blank" rel="noopener noreferrer">Python Testing with pytest - Brian Okken (Pragmatic Programmer Publishing)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://martinfowler.com/books/refactoring.html" target="_blank" rel="noopener noreferrer">Refactoring 2e - Marting Fowler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.informit.com/store/test-driven-development-by-example-9780321146533" target="_blank" rel="noopener noreferrer">Test-Driven Development: By Example - Kent Beck<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="articles"><a href="#articles" aria-hidden="true" class="header-anchor">#</a> Articles</h2> <ul><li><a href="https://realpython.com/" target="_blank" rel="noopener noreferrer">Real Python<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <ul><li><a href="https://realpython.com/pypi-publish-python-package/" target="_blank" rel="noopener noreferrer">Real Python: Packaging a Python Library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://realpython.com/pipenv-guide/" target="_blank" rel="noopener noreferrer">Real Python: A guide to Pipenv<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://realpython.com/python-testing/#testing-in-multiple-environments" target="_blank" rel="noopener noreferrer">Real Python: Automated Testing - Multiple Environments<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://realpython.com/python-mock-library/" target="_blank" rel="noopener noreferrer">Real Python: Python Mock Library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/28/2019, 3:33:09 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.80a7528a.js" defer></script><script src="/assets/js/2.aba1241c.js" defer></script><script src="/assets/js/15.ca05cee3.js" defer></script>
  </body>
</html>
